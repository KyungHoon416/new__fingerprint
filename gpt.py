import openai
import os


def build_prompt(left_txt, right_txt):
    return f"""
너는 심리학, 신체심리, 손끝 형상학, 철학적 상징 해석에 능한 감성 해석가야.  
사람의 지문을 단순한 생체 정보가 아닌, 내면의 무의식 구조와 감정의 지형도로 본다.

이제부터 제공할 두 개의 손가락 이미지 분석 요약을 기반으로  
다음 항목을 고차원적으로 해석해줘.  
너의 문장은 마치 상담실에서 따뜻한 심리학자가 조용히 들려주는 내면의 해석처럼 쓰되,  
때로는 시적이고, 때로는 분석적으로, 그리고 반드시 **사람을 존중하는 어조로** 써줘.

---

**1. 🔍 손끝의 구조적 패턴 설명**  
- 중심-외곽의 흐름, 선의 탄성, 반복성, 뻗는 방향성  
- 이로 유추되는 감정 통제 구조, 내면의 충돌 여부

**2. 🧠 감정 및 성격 구조 해석**  
- 행동보다 감정이 먼저 움직이는 사람인지  
- 감정 조절 양상(억제형/분출형/회피형/수용형)  
- 갈등 반응 시 나타나는 내면의 흐름

**3. 🌳 나무 상징 구조 해석 (Why / What / How)**  
- Why: 이 사람은 왜 이런 가지 구조를 선택했는가 (심리적 배경)  
- What: 이 나무의 줄기·가지·뿌리 구조를 해석하되,  
         뿌리는 가족·과거, 가지는 관계·표현, 줄기는 자아 구조로 해석  
- How: 지금 이 사람은 어떤 방식으로 삶을 뿌리내리고, 자라나고 있는가?

**4. 💬 감성 메시지**  
- 시 한 줄처럼 압축된, 따뜻하고 감정 회복적인 문장  
- 읽는 사람이 숨을 한번 고르게 만들 수 있을 만큼 진심이 느껴지도록

**5. ✨ 심리 예술가의 노트**  
- 손끝을 하나의 예술작품으로 보고, 전체 흐름을 ‘풍경’처럼 묘사  
- 감정의 층위, 균형감, 통제력, 관계성, 그리고 보이지 않는 내면 구조까지 종합적으로 서술

---

**6. 감정 키워드 태그**  
- 해석을 마친 후, 이 사람의 내면을 표현할 수 있는 감정 키워드 태그를 3~5개 생성  
- #자기보호 #유연한감정 #관계안의불균형 등 해시태그 형태

---

전처리 요약은 다음과 같아:

[왼손]
{left_txt}

[오른손]
{right_txt}

"""
client = openai.OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

def call_gpt_mini(prompt):
    res = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": "너는 감성 지문 분석가야."},
            {"role": "user", "content": prompt}
        ],
        max_tokens=1200
    )
    return res.choices[0].message.content
